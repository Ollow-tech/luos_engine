/******************************************************************************
 * @file luos_utils
 * @brief Some tools used to debug
 * @author Luos
 * @version 0.0.0
 ******************************************************************************/
#include <stdbool.h>
#include <stdlib.h>
#include "luos_utils.h"
#include "luos_engine.h"
#include "string.h"
#include "luos_hal.h"
#include "msg_alloc.h"
#include "_luos_phy.h"
#if (defined _WIN32) || (defined _WIN64) || (defined __linux__) || (defined __APPLE__) || (defined __unix__) || (defined __CYGWIN__) || (defined __MINGW32__) || (defined __MINGW64__)
    #include <stdio.h>
#endif

/*******************************************************************************
 * Function
 ******************************************************************************/

/******************************************************************************
 * @brief This function can be redefined by users to manage specific procedure on assert
 * @param file : File name as a string
 * @param line : line number
 * @return None
 ******************************************************************************/
__attribute__((weak)) void node_assert(char *file, uint32_t line)
{
    return;
}

/******************************************************************************
 * @brief Jump to bootloader by restarting the MCU
 * @param None
 * @return None
 ******************************************************************************/
void Luos_JumpToBootloader(void)
{
    // Set bootlaoder mode
    LuosHAL_SetMode((uint8_t)APP_RELOAD_MODE);

    // Save the current node id in flash to be ready to be reloaded
    LuosHAL_SaveNodeID(Node_Get()->node_id);

    // Reset the MCU
    LuosHAL_Reboot();
}

#ifndef UNIT_TEST
/******************************************************************************
 * @brief Luos assertion management
 * @param file : File name as a string
 * @param line : Line number
 * @return None
 *  warning : this function can be redefined only for mock testing purpose
 ******************************************************************************/
_CRITICAL void Luos_assert(char *file, uint32_t line)
{
    // Reset phy to avoid locking the phys
    Phy_Reset();
    // prepare a message as a node.
    // To do that we have to reset the service ID and clear PTP states to unlock others.

    Luos_Init();
    // completely reinit the allocator
    MsgAlloc_Init(NULL);
    Phy_FiltersInit(); // Mask filter for service ID
    msg_t msg;
    msg.header.target_mode = BROADCAST;
    msg.header.target      = BROADCAST_VAL;
    msg.header.cmd         = ASSERT;
    msg.header.size        = sizeof(line) + strlen(file);
    memcpy(msg.data, &line, sizeof(line));
    memcpy(&msg.data[sizeof(line)], file, strlen(file));
    while (Luos_SendMsg(0, &msg) != SUCCEED)
        ;
    node_assert(file, line);
    // wait for the transmission to finish before killing IRQ
    while (Luos_TxComplete() == FAILED)
        ;
    #ifdef WITH_BOOTLOADER
    // We're in a failed app,
    // Restart this node in bootloader mode instead of don't do anything
    // We will come back on this app after a reboot.
    // Set bootloader mode, save node ID and reboot
    Luos_JumpToBootloader();
    #endif
    Phy_SetIrqState(false);

    #if (defined _WIN32) || (defined _WIN64) || (defined __linux__) || (defined __APPLE__) || (defined __unix__) || (defined __CYGWIN__) || (defined __MINGW32__) || (defined __MINGW64__)
    printf("ASSERT: %s:%d\n", file, line);
    exit(1);
    #endif
    while (1)
    {
    }
}
#endif
